{% extends "base.html" %}

{% block content %}
<h2 class="text-3xl font-bold mb-6">Shopping Cart</h2>

<div id="cart-container">
    <!-- Cart items will be loaded here -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadCart();
});

function loadCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const container = document.getElementById('cart-container');
    
    if (cart.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <p class="text-xl text-gray-600">Your cart is empty</p>
                <a href="/products" class="mt-4 inline-block bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700">
                    Continue Shopping
                </a>
            </div>
        `;
        return;
    }
    
    let total = 0;
    let cartHTML = '<div class="bg-white rounded-lg shadow-md p-6">';
    
    cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        const currency = item.currency || '{{ currency }}';
        
        // Parse image URL if it's a JSON array
        let imageUrl = item.image_url;
        if (imageUrl && typeof imageUrl === 'string') {
            // Decode HTML entities
            imageUrl = imageUrl.replace(/&quot;/g, '"');
            // Parse JSON array if present
            if (imageUrl.startsWith('[')) {
                try {
                    const images = JSON.parse(imageUrl);
                    imageUrl = images[0] || null;
                } catch (e) {
                    imageUrl = null;
                }
            }
        }
        
        const imageHtml = (imageUrl && imageUrl !== '' && imageUrl !== 'None' && !imageUrl.includes('placeholder')) ? `<img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded mr-4">` : `<div class="w-16 h-16 bg-gray-200 rounded mr-4 flex items-center justify-center"><span class="text-xs text-gray-500">No Image</span></div>`;
        cartHTML += `
            <div class="flex items-center justify-between border-b py-4">
                <div class="flex items-center">
                    ${imageHtml}
                    <div>
                        <h3 class="font-semibold">${item.name}</h3>
                        <p class="text-gray-600">${currency} ${item.price.toLocaleString()}</p>
                        ${item.size ? `<p class="text-sm text-gray-500">Size: ${item.size}</p>` : ''}
                        ${item.color ? `<p class="text-sm text-gray-500">Color: ${item.color}</p>` : ''}
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="updateQuantity(${index}, -1)" class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <span class="mx-2 min-w-[2rem] text-center">${item.quantity}</span>
                        <button onclick="updateQuantity(${index}, 1)" class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                    <span class="font-semibold min-w-[4rem] text-right">${currency} ${itemTotal.toLocaleString()}</span>
                    <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700 ml-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartHTML += `
        <div class="mt-6 text-right">
            <p class="text-xl font-bold">Total: {{ currency }} ${total.toLocaleString()}</p>
            <a href="/checkout-page" class="mt-4 inline-block bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700">
                Checkout
            </a>
        </div>
    </div>`;
    
    container.innerHTML = cartHTML;
}

function updateQuantity(index, change) {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart[index].quantity += change;
    
    if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCart();
    updateCartBadge();
}

function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCart();
    updateCartBadge();
}

function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const badge = document.getElementById('cart-badge') || document.getElementById('cart-badge-guest');
    if (badge) {
        if (totalItems > 0) {
            badge.textContent = totalItems;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}
</script>
{% endblock %}