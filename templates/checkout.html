{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto p-6">
    <h2 class="text-3xl font-bold mb-6">Checkout</h2>
    
    <!-- Order Summary -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">Order Summary</h3>
        <div id="order-items" class="space-y-3 mb-4">
            <!-- Cart items will be loaded here -->
        </div>
        
        <!-- Coupon Code -->
        <div class="border-t pt-4 mb-4">
            <label class="block text-sm font-medium mb-2">Have a coupon code?</label>
            <div class="flex gap-2">
                <input type="text" id="coupon-code" placeholder="Enter code" 
                       class="flex-1 border rounded-lg px-3 py-2 uppercase">
                <button onclick="applyCoupon()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    Apply
                </button>
            </div>
            <div id="coupon-message" class="mt-2 text-sm"></div>
        </div>
        
        <div class="border-t pt-4">
            <div class="flex justify-between mb-2">
                <span>Subtotal:</span>
                <span id="subtotal-amount">KSh 0</span>
            </div>
            <div id="discount-row" class="flex justify-between mb-2 text-green-600 hidden">
                <span>Discount:</span>
                <span id="discount-amount">- KSh 0</span>
            </div>
            <div class="flex justify-between text-xl font-bold">
                <span>Total:</span>
                <span id="total-amount">KSh 0</span>
            </div>
        </div>
    </div>
    
    <!-- Customer Info -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-xl font-bold mb-4">Delivery Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Name</label>
                <input type="text" id="customer-name" value="{{ current_user.name if current_user else '' }}" 
                       class="w-full border rounded-lg px-3 py-2" readonly>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Phone</label>
                <input type="text" id="customer-phone" value="{{ current_user.phone if current_user else '' }}" 
                       class="w-full border rounded-lg px-3 py-2" readonly>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-2">Delivery Address</label>
                <textarea id="delivery-address" class="w-full border rounded-lg px-3 py-2 h-20" 
                          placeholder="Enter your delivery address" required></textarea>
            </div>
        </div>
        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                </svg>
                <div>
                    <p class="text-sm font-semibold text-green-800">Order via WhatsApp</p>
                    <p class="text-xs text-green-700">Your order will be sent to our WhatsApp for confirmation</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Place Order Button -->
    <button onclick="placeOrder()" 
            class="w-full bg-green-600 text-white py-4 rounded-lg text-lg font-bold hover:bg-green-700 transition-all flex items-center justify-center">
        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
        </svg>
        Send Order to WhatsApp
    </button>
</div>

<!-- Payment Processing Modal -->
<div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center">
            <div id="payment-content">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
                <h3 class="text-xl font-bold mb-2">Processing Payment...</h3>
                <p class="text-gray-600">Please wait while we process your payment</p>
            </div>
        </div>
    </div>
</div>

<script>
let appliedCoupon = null;
let discountAmount = 0;

// Load cart items on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCartItems();
});

function loadCartItems() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const orderItemsDiv = document.getElementById('order-items');
    const subtotalSpan = document.getElementById('subtotal-amount');
    const totalAmountSpan = document.getElementById('total-amount');
    
    let subtotal = 0;
    orderItemsDiv.innerHTML = '';
    
    if (cart.length === 0) {
        orderItemsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Your cart is empty</p>';
        return;
    }
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        orderItemsDiv.innerHTML += `
            <div class="flex items-center space-x-4 p-3 border rounded-lg">
                ${item.image_url ? `<img src="${item.image_url}" alt="${item.name}" class="w-16 h-16 object-cover rounded">` : `<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center"><span class="text-xs text-gray-500">No Image</span></div>`}
                <div class="flex-1">
                    <div class="font-medium">${item.name}</div>
                    <div class="text-sm text-gray-600">Quantity: ${item.quantity}</div>
                    <div class="text-sm text-gray-600">Unit Price: KSh ${item.price.toLocaleString()}</div>
                </div>
                <div class="text-right">
                    <div class="font-semibold">KSh ${itemTotal.toLocaleString()}</div>
                </div>
            </div>
        `;
    });
    
    subtotalSpan.textContent = `KSh ${subtotal.toLocaleString()}`;
    const total = subtotal - discountAmount;
    totalAmountSpan.textContent = `KSh ${total.toLocaleString()}`;
}

function applyCoupon() {
    const code = document.getElementById('coupon-code').value.trim();
    if (!code) return;
    
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    fetch('/validate-coupon', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({code, subtotal})
    })
    .then(r => r.json())
    .then(data => {
        const msg = document.getElementById('coupon-message');
        if (data.valid) {
            appliedCoupon = data.code;
            discountAmount = data.discount;
            msg.className = 'mt-2 text-sm text-green-600';
            msg.textContent = data.message;
            document.getElementById('discount-row').classList.remove('hidden');
            document.getElementById('discount-amount').textContent = `- KSh ${discountAmount.toLocaleString()}`;
            loadCartItems();
        } else {
            msg.className = 'mt-2 text-sm text-red-600';
            msg.textContent = data.message;
        }
    });
}

function placeOrder() {
    const deliveryAddress = document.getElementById('delivery-address').value;
    
    if (!deliveryAddress.trim()) {
        alert('Please enter your delivery address');
        return;
    }
    
    // Get cart from localStorage
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    if (cart.length === 0) {
        alert('Your cart is empty');
        return;
    }
    
    // Show payment modal
    document.getElementById('payment-modal').classList.remove('hidden');
    
    fetch('/checkout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            cart: cart,
            delivery_address: deliveryAddress,
            coupon_code: appliedCoupon,
            discount_amount: discountAmount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to WhatsApp
            window.location.href = data.whatsapp_url;
            
            // Clear cart after redirect
            localStorage.removeItem('cart');
        } else {
            document.getElementById('payment-content').innerHTML = `
                <div class="text-red-600 mb-4">
                    <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold mb-2 text-red-600">Order Failed</h3>
                <p class="text-gray-600 mb-4">${data.error}</p>
                <button onclick="closeModal()" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
                    Try Again
                </button>
            `;
        }
    })
    .catch(error => {
        document.getElementById('payment-content').innerHTML = `
            <div class="text-red-600 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold mb-2 text-red-600">Connection Error</h3>
            <p class="text-gray-600 mb-4">Please check your internet connection and try again</p>
            <button onclick="closeModal()" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
                Try Again
            </button>
        `;
    });
}

function closeModal() {
    document.getElementById('payment-modal').classList.add('hidden');
}
</script>
{% endblock %}