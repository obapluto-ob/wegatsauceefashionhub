{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
    <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">Edit Product</h2>
    
    <form method="POST" enctype="multipart/form-data">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">Product Name</label>
                <input type="text" name="name" value="{{ product.name }}" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
            </div>
            
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">Price (KSh)</label>
                <input type="number" name="price" value="{{ product.price }}" step="0.01" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
            </div>
            
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">Category</label>
                <select name="category" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
                    <option value="dresses" {% if product.category == 'dresses' %}selected{% endif %}>Dresses</option>
                    <option value="tops" {% if product.category == 'tops' %}selected{% endif %}>Tops & Blouses</option>
                    <option value="trousers" {% if product.category == 'trousers' %}selected{% endif %}>Trousers</option>
                    <option value="belts" {% if product.category == 'belts' %}selected{% endif %}>Belts</option>
                    <option value="accessories" {% if product.category == 'accessories' %}selected{% endif %}>Bags & Accessories</option>
                    <option value="shoes" {% if product.category == 'shoes' %}selected{% endif %}>Shoes</option>
                    <option value="bottoms" {% if product.category == 'bottoms' %}selected{% endif %}>Bottoms</option>
                    <option value="suits" {% if product.category == 'suits' %}selected{% endif %}>Suits</option>
                    <option value="shirts" {% if product.category == 'shirts' %}selected{% endif %}>Shirts</option>
                    <option value="pants" {% if product.category == 'pants' %}selected{% endif %}>Pants</option>
                    <option value="jackets" {% if product.category == 'jackets' %}selected{% endif %}>Jackets</option>
                </select>
            </div>
            
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">Gender</label>
                <select name="gender" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
                    <option value="women" {% if product.gender == 'women' %}selected{% endif %}>Women</option>
                    <option value="men" {% if product.gender == 'men' %}selected{% endif %}>Men</option>
                    <option value="unisex" {% if product.gender == 'unisex' %}selected{% endif %}>Unisex</option>
                </select>
            </div>
            
            <div>
                <label class="block text-gray-700 text-sm font-semibold mb-2">Stock Quantity</label>
                <input type="number" name="stock" value="{{ product.stock }}" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
            </div>
        </div>
        
        <div class="mt-6">
            <label class="block text-gray-700 text-sm font-semibold mb-2">Product Description</label>
            <textarea name="description" rows="4" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">{{ product.description }}</textarea>
        </div>
        
        <div class="mt-6">
            <label class="block text-gray-700 text-sm font-semibold mb-2">Current Images</label>
            {% if product.image_url %}
                {% if product.image_url.startswith('[') %}
                    {% set images = product.image_url | from_json %}
                    {% if images and images|length > 0 %}
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            {% for image in images %}
                            <div class="relative">
                                <img src="{{ image }}" alt="{{ product.name }}" class="w-full h-20 object-cover rounded-lg">
                                <button type="button" onclick="removeImage('{{ image }}', {{ product.id }})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        <p class="text-xs text-gray-600 mb-3">{{ images|length }} image(s) uploaded</p>
                    {% else %}
                        <div class="w-32 h-32 bg-gray-200 rounded-lg mb-3 flex items-center justify-center">
                            <span class="text-gray-500 text-sm">No Images</span>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="relative inline-block mb-3">
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" class="w-32 h-32 object-cover rounded-lg">
                        <button type="button" onclick="removeImage('{{ product.image_url }}', {{ product.id }})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600">×</button>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">1 image uploaded</p>
                {% endif %}
            {% else %}
                <div class="w-32 h-32 bg-gray-200 rounded-lg mb-3 flex items-center justify-center">
                    <span class="text-gray-500 text-sm">No Images</span>
                </div>
            {% endif %}
            
            <label class="block text-gray-700 text-sm font-semibold mb-2">Add New Images (Optional)</label>
            <input type="file" name="images" accept="image/*" multiple onchange="previewNewImages(this)"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all">
            <div id="newImagePreview" class="grid grid-cols-3 gap-2 mt-2"></div>
            <p class="text-xs text-gray-600 mt-1">Select multiple images to add to existing ones</p>
        </div>
        
        <div class="mt-8 flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
            <button type="submit" 
                    class="flex-1 bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 px-6 rounded-lg hover:from-orange-600 hover:to-red-600 transform hover:scale-105 transition-all duration-200 font-semibold shadow-lg">
                Update Product
            </button>
            <a href="/admin" 
               class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-400 transition-all text-center font-semibold">
                Cancel
            </a>
            <button type="button" onclick="deleteProduct({{ product.id }})"
                    class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition-all font-semibold">
                Delete Product
            </button>
        </div>
    </form>
</div>

<script>
function removeImage(imageUrl, productId) {
    if (confirm('Remove this image?')) {
        fetch('/admin/remove_image', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({product_id: productId, image_url: imageUrl})
        }).then(() => location.reload());
    }
}

function deleteProduct(productId) {
    if (confirm('⚠️ DELETE ENTIRE PRODUCT?\n\nThis will permanently remove:\n- Product details\n- All images\n- Cannot be undone\n\nAre you sure?')) {
        fetch('/admin/delete_product/' + productId, {
            method: 'POST'
        }).then(() => {
            window.location.href = '/admin';
        });
    }
}

function previewNewImages(input) {
    const preview = document.getElementById('newImagePreview');
    preview.innerHTML = '';
    
    if (input.files) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative';
                div.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-16 object-cover rounded border">
                    <div class="absolute bottom-0 left-0 right-0 bg-green-500 text-white text-xs text-center py-1 rounded-b">NEW</div>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }
}
</script>
{% endblock %}