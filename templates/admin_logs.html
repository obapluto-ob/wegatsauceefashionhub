{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold text-gray-800">System Logs</h2>
    <div class="flex space-x-2">
        <button onclick="refreshLogs()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-all">
            Refresh
        </button>
        <button onclick="clearLogs()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-all">
            Clear Logs
        </button>
        <a href="/admin" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-all">
            Back to Dashboard
        </a>
    </div>
</div>

<!-- Log Stats -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="grid grid-cols-4 gap-4 text-center">
        <div>
            <span class="text-2xl font-bold text-blue-600" id="total-logs">{{ logs|length }}</span>
            <p class="text-sm text-gray-600">Total Logs</p>
        </div>
        <div>
            <span class="text-2xl font-bold text-red-600" id="error-logs">{{ logs|selectattr("level", "equalto", "ERROR")|list|length }}</span>
            <p class="text-sm text-gray-600">Errors</p>
        </div>
        <div>
            <span class="text-2xl font-bold text-yellow-600" id="warning-logs">{{ logs|selectattr("level", "equalto", "WARNING")|list|length }}</span>
            <p class="text-sm text-gray-600">Warnings</p>
        </div>
        <div>
            <span class="text-2xl font-bold text-green-600" id="info-logs">{{ logs|selectattr("level", "equalto", "INFO")|list|length }}</span>
            <p class="text-sm text-gray-600">Info</p>
        </div>
    </div>
</div>

<!-- Log Filters -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="flex space-x-4 items-center">
        <label class="text-sm font-medium">Filter by Level:</label>
        <select id="level-filter" onchange="filterLogs()" class="border rounded px-3 py-1">
            <option value="all">All Levels</option>
            <option value="ERROR">Errors Only</option>
            <option value="WARNING">Warnings Only</option>
            <option value="INFO">Info Only</option>
        </select>
        
        <label class="text-sm font-medium ml-4">Search:</label>
        <input type="text" id="search-filter" onkeyup="filterLogs()" placeholder="Search logs..." class="border rounded px-3 py-1">
        
        <button onclick="exportLogs()" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 ml-4">
            Export CSV
        </button>
    </div>
</div>

<!-- Logs Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto max-h-96">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 sticky top-0">
                <tr>
                    <th class="text-left py-3 px-4 font-medium">Time</th>
                    <th class="text-left py-3 px-4 font-medium">Level</th>
                    <th class="text-left py-3 px-4 font-medium">Message</th>
                    <th class="text-left py-3 px-4 font-medium">User</th>
                    <th class="text-left py-3 px-4 font-medium">IP</th>
                </tr>
            </thead>
            <tbody id="logs-table">
                {% for log in logs|reverse %}
                <tr class="border-b hover:bg-gray-50 log-row" data-level="{{ log.level }}" data-message="{{ log.message|lower }}">
                    <td class="py-2 px-4 text-xs text-gray-600">{{ log.timestamp }}</td>
                    <td class="py-2 px-4">
                        <span class="px-2 py-1 rounded text-xs font-semibold
                            {% if log.level == 'ERROR' %}bg-red-100 text-red-800
                            {% elif log.level == 'WARNING' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ log.level }}
                        </span>
                    </td>
                    <td class="py-2 px-4">{{ log.message }}</td>
                    <td class="py-2 px-4 text-xs">{{ log.user_id or 'N/A' }}</td>
                    <td class="py-2 px-4 text-xs">{{ log.ip or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Auto-refresh toggle -->
<div class="mt-4 text-center">
    <label class="inline-flex items-center">
        <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()" class="mr-2">
        <span class="text-sm">Auto-refresh every 5 seconds</span>
    </label>
</div>

<script>
let autoRefreshInterval = null;

function refreshLogs() {
    fetch('/admin/logs/data')
        .then(response => response.json())
        .then(data => {
            updateLogsTable(data.logs);
            updateStats(data.logs);
        })
        .catch(error => console.error('Error:', error));
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs?')) {
        fetch('/admin/logs/clear', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
    }
}

function filterLogs() {
    const levelFilter = document.getElementById('level-filter').value;
    const searchFilter = document.getElementById('search-filter').value.toLowerCase();
    const rows = document.querySelectorAll('.log-row');
    
    rows.forEach(row => {
        const level = row.dataset.level;
        const message = row.dataset.message;
        
        const levelMatch = levelFilter === 'all' || level === levelFilter;
        const searchMatch = searchFilter === '' || message.includes(searchFilter);
        
        row.style.display = (levelMatch && searchMatch) ? '' : 'none';
    });
}

function exportLogs() {
    const rows = document.querySelectorAll('.log-row:not([style*="display: none"])');
    let csv = 'Timestamp,Level,Message,User,IP\n';
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => 
            '"' + cell.textContent.replace(/"/g, '""') + '"'
        ).join(',');
        csv += rowData + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'system_logs_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function toggleAutoRefresh() {
    const checkbox = document.getElementById('auto-refresh');
    
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(refreshLogs, 5000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
}

function updateLogsTable(logs) {
    const tbody = document.getElementById('logs-table');
    tbody.innerHTML = '';
    
    logs.reverse().forEach(log => {
        const levelClass = log.level === 'ERROR' ? 'bg-red-100 text-red-800' :
                          log.level === 'WARNING' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-green-100 text-green-800';
        
        const row = `
            <tr class="border-b hover:bg-gray-50 log-row" data-level="${log.level}" data-message="${log.message.toLowerCase()}">
                <td class="py-2 px-4 text-xs text-gray-600">${log.timestamp}</td>
                <td class="py-2 px-4">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${levelClass}">
                        ${log.level}
                    </span>
                </td>
                <td class="py-2 px-4">${log.message}</td>
                <td class="py-2 px-4 text-xs">${log.user_id || 'N/A'}</td>
                <td class="py-2 px-4 text-xs">${log.ip || 'N/A'}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function updateStats(logs) {
    document.getElementById('total-logs').textContent = logs.length;
    document.getElementById('error-logs').textContent = logs.filter(l => l.level === 'ERROR').length;
    document.getElementById('warning-logs').textContent = logs.filter(l => l.level === 'WARNING').length;
    document.getElementById('info-logs').textContent = logs.filter(l => l.level === 'INFO').length;
}
</script>
{% endblock %}