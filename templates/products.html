{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-3xl font-bold text-gray-800">Products</h2>
        
        <!-- Gender Filter -->
        <div class="flex space-x-2">
            <a href="/products" class="px-4 py-2 rounded-lg {% if not request.args.get('gender') %}bg-orange-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-all">
                All
            </a>
            <a href="/products?gender=women" class="px-4 py-2 rounded-lg {% if request.args.get('gender') == 'women' %}bg-pink-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-all">
                Women
            </a>
            <a href="/products?gender=men" class="px-4 py-2 rounded-lg {% if request.args.get('gender') == 'men' %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-all">
                Men
            </a>
        </div>
    </div>
    
    <!-- Search Bar -->
    <form method="GET" action="/products" class="mb-4">
        <div class="flex gap-2">
            <input type="text" name="search" value="{{ request.args.get('search', '') }}" 
                   placeholder="Search products..." 
                   class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:border-orange-500">
            <button type="submit" class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-all">
                Search
            </button>
        </div>
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for product in products %}
    <div class="bg-orange-100 rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-all transform hover:-translate-y-1">
        {% if product.image_url %}
            {% if product.image_url.startswith('[') %}
                {% set images = product.image_url | from_json %}
                {% if images and images|length > 0 %}
                    <img src="{{ images[0] }}" alt="{{ product.name }}" class="h-48 w-full object-cover">
                {% else %}
                    <div class="h-48 bg-gradient-to-br from-orange-200 to-red-300 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-2">
                                <div class="w-6 h-6 bg-red-500 rounded"></div>
                            </div>
                            <span class="text-red-700 text-sm">No Image</span>
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <img src="{{ product.image_url }}" alt="{{ product.name }}" class="h-48 w-full object-cover">
            {% endif %}
        {% else %}
            <div class="h-48 bg-gradient-to-br from-orange-200 to-red-300 flex items-center justify-center">
                <div class="text-center">
                    <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-2">
                        <div class="w-6 h-6 bg-red-500 rounded"></div>
                    </div>
                    <span class="text-red-700 text-sm">No Image</span>
                </div>
            </div>
        {% endif %}
        <div class="p-4">
            <h3 class="text-lg font-semibold mb-2">{{ product.name }}</h3>
            <p class="text-gray-600 mb-2">{{ product.description }}</p>
            <div class="mb-2">
                <span class="text-xs px-2 py-1 rounded-full {% if product.gender == 'women' %}bg-pink-100 text-pink-800{% elif product.gender == 'men' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ product.gender.title() if product.gender else 'Unisex' }}
                </span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <span class="text-xl font-bold text-red-600">{{ currency }} {{ "%.2f"|format(product.display_price) }}</span>
                {% if currency != 'KSh' %}
                    <span class="text-sm text-gray-500">KSh {{ product.price }}</span>
                {% endif %}
            </div>
            <div class="flex space-x-2">
                <button onclick="quickView({{ product.id }})" 
                        class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-2 px-4 rounded hover:from-blue-600 hover:to-purple-600 transition-all text-center">
                    Quick View
                </button>
                <button onclick="quickAddToCart({{ product.id }})" 
                        id="cart-btn-{{ product.id }}"
                        class="flex-1 bg-gradient-to-r from-red-500 to-orange-500 text-white py-2 px-4 rounded hover:from-red-600 hover:to-orange-600 transition-all">
                    <span id="cart-text-{{ product.id }}">Add to Cart</span>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Quick View Modal -->
<div id="quick-view-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="qv-name"></h2>
                <button onclick="closeQuickView()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <img id="qv-image" src="" alt="" class="w-full h-96 object-cover rounded-lg">
                </div>
                <div>
                    <p id="qv-description" class="text-gray-700 mb-4"></p>
                    <div class="text-3xl font-bold text-purple-600 mb-4" id="qv-price"></div>
                    <div class="mb-4">
                        <label class="block font-semibold mb-2">Quantity</label>
                        <input type="number" id="qv-qty" value="1" min="1" max="10" class="w-20 border rounded-lg px-3 py-2">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addFromQuickView()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:from-purple-700 hover:to-pink-700">
                            Add to Cart
                        </button>
                        <a id="qv-full-link" href="" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-300 text-center">
                            Full Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cart = [];

// Update cart indicators on page load
document.addEventListener('DOMContentLoaded', function() {
    cart = JSON.parse(localStorage.getItem('cart') || '[]');
    updateCartIndicators();
    updateCartBadge();
});

function updateCartIndicators() {
    cart.forEach(item => {
        const btn = document.getElementById(`cart-btn-${item.id}`);
        const text = document.getElementById(`cart-text-${item.id}`);
        if (btn && text) {
            btn.classList.remove('from-red-500', 'to-orange-500', 'hover:from-red-600', 'hover:to-orange-600');
            btn.classList.add('from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
            text.textContent = `In Cart (${item.quantity})`;
        }
    });
}

function quickAddToCart(productId) {
    const existingItem = cart.find(item => item.id == productId);
    if (existingItem) {
        existingItem.quantity += 1;
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartIndicators();
        updateCartBadge();
        showToast(`Updated quantity to ${existingItem.quantity}!`, 'blue');
        return;
    }
    
    fetch('/add_to_cart', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({product_id: productId, quantity: 1})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            cart.push({
                id: data.product.id,
                name: data.product.name,
                price: data.product.price,
                quantity: 1,
                image_url: data.product.image_url,
                currency: '{{ currency }}'
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartIndicators();
            updateCartBadge();
            showToast('Added to cart!', 'green');
        }
    });
}

function showToast(message, color) {
    const colors = {green: 'bg-green-500', blue: 'bg-blue-500', red: 'bg-red-500'};
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${colors[color]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function updateCartBadge() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    const badge = document.getElementById('cart-badge') || document.getElementById('cart-badge-guest');
    if (badge) {
        if (totalItems > 0) {
            badge.textContent = totalItems;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

let currentQuickViewProduct = null;
function quickView(productId) {
    fetch(`/api/product/${productId}`)
    .then(r => r.json())
    .then(product => {
        currentQuickViewProduct = product;
        document.getElementById('qv-name').textContent = product.name;
        document.getElementById('qv-description').textContent = product.description;
        document.getElementById('qv-price').textContent = `{{ currency }} ${product.display_price.toFixed(2)}`;
        
        let imageUrl = product.image_url;
        if (imageUrl && imageUrl.startsWith('[')) {
            const images = JSON.parse(imageUrl);
            imageUrl = images[0] || '';
        }
        document.getElementById('qv-image').src = imageUrl;
        document.getElementById('qv-full-link').href = `/product/${product.id}`;
        document.getElementById('quick-view-modal').classList.remove('hidden');
    });
}

function closeQuickView() {
    document.getElementById('quick-view-modal').classList.add('hidden');
}

function addFromQuickView() {
    const qty = parseInt(document.getElementById('qv-qty').value);
    quickAddToCart(currentQuickViewProduct.id, qty);
    closeQuickView();
}
</script>
{% endblock %}